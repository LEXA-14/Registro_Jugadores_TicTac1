@page "/"
@inject PartidasServices partidasServices
@inject JugadoresServicios jugadoresServicios
@inject NavigationManager navigationManager
@using Registro_Jugadores_TicTac1.Models
@using Registro_Jugadores_TicTac1.Services
@rendermode InteractiveServer

<div class="container mx-auto max-w-lg p-6 bg-white rounded-lg shadow-xl text-center">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Seleccionar Jugadores</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- SELECCIÓN DEL JUGADOR X -->
        <div>
            <label class="form-label font-semibold text-lg text-gray-700">Jugador X</label>
            <InputSelect class="form-select mt-2 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500"
                         @bind-Value="partida.Jugador1Id">
                <option value="0" selected disabled>Seleccione un jugador</option>
                @foreach (var jugador in ListaJugadores)
                {
                    <option value="@jugador.JugadorId"
                            disabled="@(jugador.JugadorId == partida.Jugador2Id)">
                        @jugador.Nombres
                    </option>
                }
            </InputSelect>
        </div>

        <!-- SELECCIÓN DEL JUGADOR O -->
        <div>
            <label class="form-label font-semibold text-lg text-gray-700">Jugador O</label>
            <InputSelect class="form-select mt-2 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500"
                         @bind-Value="partida.Jugador2Id">
                <option value="0" selected disabled>Seleccione un jugador</option>
                @foreach (var jugador in ListaJugadores)
                {
                    <option value="@jugador.JugadorId"
                            disabled="@(jugador.JugadorId == partida.Jugador1Id)">
                        @jugador.Nombres
                    </option>
                }
            </InputSelect>
        </div>
    </div>

    <div class="card-footer">

    <!-- BOTÓN PARA INICIAR LA PARTIDA -->
    <button class="btn btn-outline-primary"
            disabled="@(!ValidoSeleccion)"
            @onclick="IniciarPartida">
        Iniciar Partida
    </button>
    </div>
</div>

@code {
    private List<Jugadores> ListaJugadores = new List<Jugadores>();
    private Partidas partida = new Partidas();

    private bool ValidoSeleccion => partida.Jugador1Id > 0 && partida.Jugador2Id > 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            ListaJugadores = await jugadoresServicios.GetList(j=>j.JugadorId>0);
            Console.WriteLine($"Se cargaron {ListaJugadores.Count} jugadores.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar los jugadores: {ex.Message}");
        }
    }

    private async Task IniciarPartida()
    {
        if (ValidoSeleccion)
        {
            partida.FechaInicio = DateTime.Now;
            partida.EstadoPartida = "En Progreso";
            partida.EstadoTablero = "---------";
            partida.TurnoJugadorId = partida.Jugador1Id;

            await partidasServices.Registrar(partida);

            navigationManager.NavigateTo($"/JuegoTablero/{partida.PartidaId}");
        }
    }
}
